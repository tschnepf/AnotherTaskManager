limit_req_zone $binary_remote_addr zone=taskhub_ingest:10m rate=10r/m;
map $http_x_forwarded_proto $taskhub_forwarded_proto {
  default $http_x_forwarded_proto;
  "" $scheme;
}
map $http_host $taskhub_forwarded_port {
  ~:(?<p>\d+)$ $p;
  default $server_port;
}
resolver 127.0.0.11 valid=10s ipv6=off;

server {
  listen 80;
  server_name _;
  client_max_body_size 120m;
  limit_req_status 429;
  set $taskhub_api_upstream http://api:8000;
  set $taskhub_idp_upstream http://keycloak:8080;

  root /usr/share/nginx/html;
  index index.html;

  location = /capture/email/inbound {
    limit_req zone=taskhub_ingest burst=20 nodelay;
    client_max_body_size 21m;
    proxy_pass $taskhub_api_upstream;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Port $taskhub_forwarded_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $taskhub_forwarded_proto;
  }

  location = /capture/email/inbound/ {
    limit_req zone=taskhub_ingest burst=20 nodelay;
    client_max_body_size 21m;
    proxy_pass $taskhub_api_upstream;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Port $taskhub_forwarded_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $taskhub_forwarded_proto;
  }

  location /api/mobile/v1/ {
    proxy_pass $taskhub_api_upstream;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Port $taskhub_forwarded_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $taskhub_forwarded_proto;
  }

  location /idp/ {
    proxy_pass $taskhub_idp_upstream;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Port $taskhub_forwarded_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $taskhub_forwarded_proto;
  }

  location ~ ^/(auth|tasks|projects|tags|views|health|admin|capture|ops|settings/email-capture)(/|$) {
    proxy_pass $taskhub_api_upstream;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Port $taskhub_forwarded_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $taskhub_forwarded_proto;
  }

  location / {
    try_files $uri /index.html;
  }
}
